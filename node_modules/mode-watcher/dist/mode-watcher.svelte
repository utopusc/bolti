<script>import { onMount } from "svelte";
import {
  defineConfig,
  disableTransitions as disableTransitionsStore,
  mode,
  setInitialMode,
  setMode,
  setTheme,
  systemPrefersMode,
  themeColors as themeColorsStore
} from "./mode.js";
import {
  darkClassNames as darkClassNamesStore,
  isValidMode,
  lightClassNames as lightClassNamesStore,
  modeStorageKey as modeStorageKeyStore,
  themeStorageKey as themeStorageKeyStore
} from "./stores.js";
export let track = true;
export let defaultMode = "system";
export let themeColors = void 0;
export let disableTransitions = true;
export let darkClassNames = ["dark"];
export let lightClassNames = [];
export let defaultTheme = "";
export let nonce = "";
export let themeStorageKey = "mode-watcher-theme";
export let modeStorageKey = "mode-watcher-mode";
$: disableTransitionsStore.set(disableTransitions);
$: themeColorsStore.set(themeColors);
$: darkClassNamesStore.set(darkClassNames);
$: lightClassNamesStore.set(lightClassNames);
$: modeStorageKeyStore.set(modeStorageKey);
$: themeStorageKeyStore.set(themeStorageKey);
onMount(() => {
  const unsubscriber = mode.subscribe(() => {
  });
  systemPrefersMode.tracking(track);
  systemPrefersMode.query();
  const localStorageMode = localStorage.getItem($modeStorageKeyStore);
  setMode(isValidMode(localStorageMode) ? localStorageMode : defaultMode);
  const localStorageTheme = localStorage.getItem($themeStorageKeyStore);
  setTheme(localStorageTheme || defaultTheme);
  return () => {
    unsubscriber();
  };
});
const initConfig = defineConfig({
  defaultMode,
  themeColors,
  darkClassNames,
  lightClassNames,
  defaultTheme,
  modeStorageKey,
  themeStorageKey
});
$: trueNonce = typeof window === "undefined" ? nonce : "";
</script>

<svelte:head>
	{#if themeColors}
		<!-- default to dark mode for to allow testing -->
		<!-- this will be overwritten by FOUC prevention snippet below -->
		<!-- but that snippet does not run in vitest -->
		<meta name="theme-color" content={themeColors.dark} />
	{/if}

	{#if trueNonce}
		<!-- eslint-disable-next-line svelte/no-at-html-tags prefer-template -->
		{@html `<script nonce=${trueNonce}>(` +
			setInitialMode.toString() +
			`)(` +
			JSON.stringify(initConfig) +
			`);</script>`}
	{:else}
		<!-- eslint-disable-next-line svelte/no-at-html-tags prefer-template -->
		{@html `<script>(` +
			setInitialMode.toString() +
			`)(` +
			JSON.stringify(initConfig) +
			`);</script>`}
	{/if}
</svelte:head>
